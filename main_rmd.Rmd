---
title: "main_rmd"
output: html_document
date: "2023-02-09"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(torch)
library(progress)
source("utils_torch.R")
source("gain_torch_modified.R")
sim <- function(){
  n  <- 2000
  n2 <- 500
  
  beta <- c(1, 1, 1)
  e_U <- c(sqrt(3),sqrt(3))
  mx <- 0; sx <- 1; zrange <- 1; zprob <- .5
  
  simZ   <- rbinom(n, zrange, zprob)
  simX   <- (1-simZ)*rnorm(n, 0, 1) + simZ*rnorm(n, 0.5, 1)
  #error
  epsilon <- rnorm(n, 0, 1)
  #Y is added with epsilon
  simY    <- beta[1] + beta[2]*simX + beta[3]*simZ + epsilon
  #make X_star depends on it
  simX_tilde <- simX + rnorm(n, 0, e_U[1]*(simZ==0) + e_U[2]*(simZ==1))
  data_full <- data.frame(X_tilde=simX_tilde, Y=simY, X=simX, Z=simZ)
  ##### Designs
  ## SRS
  data <- data_full
  id_phase2 <- c(sample(n, n2))
  data$X[-id_phase2] <- NA
  return (list(data, data_full))
}
```

```{r}
# library(tensorflow)
# source("gain.R")
# source("utils.R")
# x <- import("tensorflow.compat.v1") 
# x$disable_v2_behavior()

output <- sim()
data <- output[[1]]
data_full <- output[[2]]

data <- read.csv("Missing.csv")
data$R <- 1 * !is.na(data$X)
write.csv(data, "Missing.csv")

ind <- which(is.na(data$X))

imp <- gain(data, 128, 0.9, 10, 5000)
imp$Z <- round(imp$Z)

errormod <- lm(X ~ X_tilde + Y + Z, data = data_full)
summary(errormod)

modfull <- lm(Y ~ X + Z, data = data_full)
summary(modfull)

modmis <- lm(Y ~ X + Z, data = data)
summary(modmis)

mod <- lm(Y ~ X + Z, data = imp)
summary(mod)

modimp <- lm(X ~ X_tilde + Y + Z, data = imp[ind, ])
summary(modimp)


py <- list(0)
for (i in seq(0, 9)){
  py[[i + 1]] <- read.csv(paste0("tryTwo", i, ".csv"))
  py[[i + 1]] <- py[[i + 1]][, -1]
  names(py[[i + 1]]) <- names(data)[2:5]
}


coef_X <- coef_Xti <- sd_X <- sd_Xti <- NULL
for (i in 1:10){
  mod <- lm(Y ~ X + Z, data = py[[i]][ind, ])
  modimp <- lm(X ~ X_tilde + Y + Z, data = py[[i]][ind, ])
  
  coef_X[i] <- coef(mod)[2]
  coef_Xti[i] <- coef(modimp)[2]
  
  sd_X[i] <- vcov(mod)[2, 2]
  sd_Xti[i] <- vcov(modimp)[2, 2]
}

data <- data[, -c(1, dim(data)[2])]
library(mixgb)
data <- data[-2000, ]
coef_X
plot_hist(imputation.list = py, var.name = "X",
    original.data = data)
plot_2num(imputation.list = py, var.x = "X_tilde",
    var.y = "X", original.data = data)
```
```{r}
library(missMethods)
data_mis <- delete_MCAR(data_full, p = 0.3)
imp <- gain(data_mis)
imp$Z <- round(imp$Z)
mod <- lm(Y ~ X + Z, data = imp)
summary(mod)

imp_da <- mixgb(data)
mod <- lm(Y ~ X + Z, data = imp_da[[2]][ind, ])
summary(mod)

plot_hist(imputation.list = imp_da, var.name = "X",
    original.data = data)
```

```{r}
save(data, data_full, file = "data.RData")
coef <- sd <- NULL
for (i in 1:10){
  imp <- gain(data, 128, 0.9, 10, 5000)
  imp$Z <- round(imp$Z)
  save(imp, file = paste0("imp", i, ".RData"))
  mod <- lm(Y ~ X + Z, data = imp[ind, ])
  summary(mod)
  coef[i] <- coef(mod)[2]
  sd[i] <- sqrt(vcov(mod)[2, 2])
}
summary(mod)

coef
mean(coef)
sd
mean(sd) + (5 + 1) * var(coef) / 5

modfull <- lm(Y ~ X + Z, data = data_full)
summary(modfull)

modmis <- lm(Y ~ X + Z, data = data)
summary(modmis)
```


```{r}
load("SampleData_0001.RData")
library(survey)
library(data.table)
library(tidyverse)
data <- samp <- as.data.frame(samp) 
samp.solnas <- samp[(samp$solnas==T),]
lm.lsodi <- glm(c_ln_na_bio1 ~ c_age + c_bmi + c_ln_na_avg + high_chol + usborn + female + bkg_pr + bkg_o,
                data=samp.solnas)
samp$c_ln_na_calib <- as.matrix(predict(lm.lsodi, newdata=samp, type = 'response'))
samp <- samp %>% dplyr::select(-matches("true")) %>% dplyr::select(-matches("bio"))
samp$c_ln_na_bio1[samp$solnas == F] <- NA
samp$c_ln_na_bio1[samp$solnas == T] <- data$c_ln_na_bio1[samp$solnas == T]


samp$sex <- ifelse(samp$sex == "M", 1, 0)
samp$hisp.strat <- 1 * samp$hisp.strat
samp$age.strat <- 1 * samp$age.strat
samp <- samp %>% select(-bkg, -idx, -strat, -BGid, -hhid, -hisp.strat, -subid, -v.num)
samp$R <- ifelse(is.na(samp$c_ln_na_bio1), 0, 1)
imp <- gain(samp)

modcoef_hyper <- modvar_hyper <- modcoef_sbp <- modvar_sbp <- matrix(rep(0, 9 * 3), ncol = 9)
for (i in 1:3){
  imp <- gain(samp)
  imp$BGid <- samp$BGid
  imp$strat <- samp$strat
  
  mi.design <- svydesign(id=~BGid, strata=~strat, weights=~bghhsub_s2, data=imp)
  
  mod_hyper <- svyglm(hypertension ~ c_age + c_bmi + c_ln_na_bio1 + 
                        high_chol + usborn + female + bkg_pr + bkg_o,design=mi.design,family=quasibinomial())
  mod_sbp <- svyglm(sbp ~ c_age + c_bmi + c_ln_na_bio1 + 
                      high_chol + usborn + female + bkg_pr + bkg_o,design=mi.design,family=gaussian())
  
  modcoef_hyper[i, ] <- mod_hyper$coeff
  modcoef_sbp[i, ] <- mod_sbp$coeff
  
  modvar_hyper[i, ] <- summary(mod_hyper)$coeff[, 2]^2
  modvar_sbp[i, ] <- summary(mod_sbp)$coeff[, 2]^2
}

head(samp)
head(imp)
```

